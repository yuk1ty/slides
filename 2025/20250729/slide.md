---
marp: true
theme: rose-pine-custom
paginate: true
---

<!-- _paginate: skip -->

# ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ã¨å­¦ã¶Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©

2025/07/29
Rustã®ç¾å ´ã«å­¦ã¶ ã€œWebã‚¢ãƒ—ãƒªã®è£å´ã‹ã‚‰OSã€äººå·¥è¡›æ˜Ÿã¾ã§ã€œ

---

## ç›®æ¬¡

- å‰æã®æ•´ç†
- ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ï¼Ÿ
- Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
- Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©é–‹ç™ºã®å€‹äººçš„ä½“é¨“

---

## å‰æã®æ•´ç†

- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã«é–¢ã™ã‚‹ã‚ã‚‹ç¨‹åº¦ã®çŸ¥è­˜ã¯æ—¢çŸ¥ã¨ã•ã›ã¦ãã ã•ã„ğŸ™‡ğŸ»â€â™€ï¸ èª¬æ˜ã—ã¦ã„ã‚‹ã¨ã•ã™ãŒã«15åˆ†ã€œ20åˆ†ã§ã¯æ‰±ã„ãã‚Œãªã„ãŸã‚ã§ã™ã€‚
  - å­—å¥è§£æï¼ˆãƒ¬ã‚­ã‚µï¼‰ã€æ§‹æ–‡è§£æï¼ˆãƒ‘ãƒ¼ã‚µãƒ¼ï¼‰ã€æŠ½è±¡æ§‹æ–‡æœ¨ã‚ãŸã‚Šã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒã¤ã‘ã°å¤§ä¸ˆå¤«â€¦ã ã¨æ€ã†ã€‚
  - æ˜”è¨˜äº‹ã‚’æ›¸ã„ãŸã‚‰ã—ã„ï¼ˆ6å¹´å‰ã£ã¦æ›¸ã„ã¦ã‚ã£ã¦ã³ã£ãã‚Šã—ã¦ã‚‹ï¼‰ã€‚
    - Rust LT#2 ã§è©±ã‚’ã—ã¾ã—ãŸ & ãã®è©±ã®è©³ç´°ãªè§£èª¬: https://blog-dry.com/entry/2018/08/03/184806
    
---

## å‰æã®æ•´ç†

- å°ºã®éƒ½åˆã§å®Ÿè£…ãƒ¬ãƒ™ãƒ«ã®è©±ã¾ã§ã¯è¸ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚
- æ‡‡è¦ªä¼šã§ãŠè©±ã—ã—ã¾ã—ã‚‡ã†â€¦ï¼ç§ã‚‚åˆå¿ƒè€…ã§ã™ãŒã€‚
    
---

## ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ï¼Ÿ
### å®šç¾©

- ç§ãŒå‹æ‰‹ã«ãã†å‘¼ã‚“ã§ã„ã‚‹ã ã‘ã§ã€ä¸€èˆ¬çš„ãªå®šç¾©ã¯ãªã„ã€‚
- æ™‚æŠ˜ç¾ã‚Œã¦Issueã‚’è§£æ±ºã—ã¦ã„ãäººã€‚
- ã‚¬ãƒå‹¢ã§ã¯ãªã„ï¼ˆã®ã§ã€ã€Œã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã€ï¼‰ãŒã€å¤šå°‘ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã«è©³ã—ã„ã ã‚ã†ã¨ã„ã†ã“ã¨ã§ä»Šæ—¥è©±ã‚’ã™ã‚‹ã€‚

---

## ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ï¼Ÿ
### å‹•æ©Ÿ

- è»¢è·ã—ã¦Rustã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã¯ãªããªã£ãŸã®ã§ã€Rustã‚’è§¦ã‚‹æ©Ÿä¼šãŒæ¿€æ¸›ã—ãŸã€‚
- å‰ã‹ã‚‰ã‚„ã£ã¦ã¿ãŸã‹ã£ãŸRustæœ¬ä½“ã¸ã®ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã—ã¦ã¿ã‚‹ã“ã¨ã«ã€‚
  - å¾Œè¿°ã™ã‚‹ã‚ˆã†ã«AIã®åŠ›ã®ãŠã‹ã’ã§ã€ã‹ãªã‚Šã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã—ã‚„ã™ããªã£ãŸã€‚

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´

- **å…¨ä½“çš„ãªæ§‹æˆ**: ã‚ˆãã‚ã‚‹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã€‚ASTã‚’æ§‹ç¯‰å¾Œã€ä¸­é–“è¡¨ç¾ã«å¤‰æ›ã—ã€ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’çµŒã¦ãƒã‚¤ãƒŠãƒªãŒä½œã‚‰ã‚Œã‚‹ã€‚
- **ç‰¹å¾´çš„ãªè¨­è¨ˆ**: ã‚¯ã‚¨ãƒªãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒèµ°ã‚‹ã€‚ä¸å¯§ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ãƒˆãƒ¬ã‚¤ãƒˆãƒªã‚¾ãƒ«ãƒã‚ãŸã‚Šã¯Rustç‰¹æœ‰ã‹ã‚‚ã€‚

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å…¨ä½“çš„ãªæ§‹æˆ

Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©å†…ã§ã¯ã€å¤§ã¾ã‹ã«ã¯æ¬¡ã®ã‚ˆã†ã«ã€Œä¸­é–“è¡¨ç¾ï¼ˆIRï¼‰ã€ãŒå¤‰æ›ã•ã‚Œã¦ã„ãã€‚

- AST
- HIR
- MIR
- LLVM IR (Codegen)

ä¸Šã®ãƒ•ã‚§ãƒ¼ã‚ºã‹ã‚‰ä¸‹ã®ãƒ•ã‚§ãƒ¼ã‚ºã«ä¸­é–“è¡¨ç¾ãŒç›´ã•ã‚Œã¦ã„ãã“ã¨ã‚’ã€Œ**lowering**ã€ã¨å‘¼ã¶ã€‚

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å…¨ä½“çš„ãªæ§‹æˆ: AST

- ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è§£æï¼ˆå­—å¥ã€æ§‹æ–‡ï¼‰ã—ã€æŠ½è±¡æ§‹æ–‡æœ¨ï¼ˆAbstract Syntax Tree; ASTï¼‰ã«ç›´ã™ãƒ•ã‚§ãƒ¼ã‚ºã€‚
- ã¡ãªã¿ã«Rustã¯ã€å†å¸°ä¸‹é™æ§‹æ–‡è§£æã§ã€ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’æ‰‹ã§å®Ÿè£…ã—ã¦ã„ã‚‹ã€‚

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å…¨ä½“çš„ãªæ§‹æˆ: HIR

- HIR (High-level Intermediate Representation) ã¨å‘¼ã°ã‚Œã‚‹ä¸­é–“è¡¨ç¾ãŒã¾ãšã¯ç”Ÿæˆã•ã‚Œã‚‹ã€‚ãã®å¾ŒTHIR (Typed High-level Intermediate Representation)ãŒç”Ÿæˆã•ã‚Œã€æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆMIRï¼‰ã«æ¸¡ã•ã‚Œã‚‹ã€‚
- ä¸»ã«ã¯è„±ç³–ï¼ˆdesugarï¼‰ã‚’æ‹…ã†ã€‚ãŸã¨ãˆã°ã€Rustã®æ–‡æ³•ä¸Šç¾ã‚Œã‚‹ä¸‹è¨˜ã®æ–‡æ³•æ©Ÿèƒ½ã¯ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©å†…éƒ¨ã§ã¯é•ã†å½¢ã§æ‰±ã‚ã‚Œã‚‹ã€‚
  - forå¼ã‚„whileå¼ã¯ã€ã™ã¹ã¦match + loopã«å¤‰æ›ã•ã‚Œã‚‹ã€‚
  - asyncã‚„awaitã¯ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©å†…éƒ¨è¡¨ç¾ã¨ã—ã¦ã‚³ãƒ«ãƒ¼ãƒãƒ³ã«å¤‰æ›ã•ã‚Œã‚‹ã€‚

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å…¨ä½“çš„ãªæ§‹æˆ: HIR

- ãã®ã»ã‹ã€å‹ã«é–¢ã™ã‚‹ã•ã¾ã–ã¾ãªè§£æãŒã‹ã‘ã‚‰ã‚Œã‚‹ã€‚
  - å‹æ¨è«–ã€ãƒˆãƒ¬ã‚¤ãƒˆã¨å®Ÿè£…ã®ç´ä»˜ã‘ã€å‹ãƒã‚§ãƒƒã‚¯ã¯HIRã¸ã®å¤‰æ›ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è¡Œã‚ã‚Œã‚‹ã€‚
  - ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒæ™‚ã«ç¾ã‚Œã‚‹ç¶²ç¾…æ€§ãƒã‚§ãƒƒã‚¯ã¯ã€THIRã¸ã®å¤‰æ›ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è¡Œã‚ã‚Œã‚‹ã€‚

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å…¨ä½“çš„ãªæ§‹æˆ: HIR

ï¼ˆã‚³ãƒ¼ãƒ‰ã‹ã‚‰HIRã‚’å‡ºåŠ›ã—ã¦ã¿ãŸä¾‹ã‚’å‡ºã™ï¼‰

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å…¨ä½“çš„ãªæ§‹æˆ: HIR

HIRã¯ã€æ¬¡ã®cargoã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã‚‹ã€‚

```
cargo rustc -- -Z unpretty=hir-tree
cargo rustc -- -Z unpretty=hir
cargo rustc -- -Z unpretty=thir-tree
```

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å…¨ä½“çš„ãªæ§‹æˆ: HIR

è©¦ã—ã«ä¸‹è¨˜ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’HIRã¨ã—ã¦å‡ºåŠ›ã•ã›ã¦ã¿ã‚‹ã€‚

```rust
fn main() {
    let nums = vec![1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
    let mut ans = 0;
    for num in nums {
        ans += num;
    }
    assert_eq!(ans, 55);
}
```

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å…¨ä½“çš„ãªæ§‹æˆ: HIR

æœ¬æ¥ã®HIRè‡ªä½“ã¯ã“ã®ã‚ˆã†ã«ASTã«è¿‘ã—ã„å½¢ã ãŒã€å°‘ã—èª­ã¿ã«ãã„ã®ã§Rustã‚³ãƒ¼ãƒ‰ã«è¿‘ã„å½¢å¼ã§å‡ºåŠ›ã•ã›ã‚‹ã€‚

```
DefId(0:0 ~ for_hir[8e24]) => OwnerNodes {
    node: ParentedNode {
        parent: 4294967040,
        node: Crate(
            Mod {
                spans: ModSpans {
                    inner_span: src/bin/for_hir.rs:1:1: 8:2 (#0),
                    inject_use_span: no-location (#0),
                },
                item_ids: [
                    ItemId {
                        owner_id: DefId(0:1 ~ for_hir[8e24]::{use#0}),
                    },
                    ItemId {
                        owner_id: DefId(0:2 ~ for_hir[8e24]::std),
                    },

```

---

ã™ã‚‹ã¨ã€forå¼ãŒmatch, loop, matchã®å½¢å¼ã§å¤‰æ›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã‚‹ã€‚

```rust
// ...
fn main() {
    let nums =
        <[_]>::into_vec(::alloc::boxed::box_new([1, 2, 3, 4, 5, 6, 7, 8, 9,
                        10]));
    let mut ans = 0;
    {
        let _t =
            match #[lang = "into_iter"](nums) {
                mut iter =>
                    loop {
                        match #[lang = "next"](&mut iter) {
                            #[lang = "None"] {} => break,
                            #[lang = "Some"] {  0: num } => { ans += num; }
                        }
                    },
            };
        _t
    };
    match (&ans, &55) {
        (left_val, right_val) => {
            if !(*left_val == *right_val) {
                let kind = ::core::panicking::AssertKind::Eq;
                ::core::panicking::assert_failed(kind, &*left_val,
                    &*right_val, ::core::option::Option::None);
            }
        }
    };
}
```

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å…¨ä½“çš„ãªæ§‹æˆ: MIR

- THIRã‹ã‚‰MIRï¼ˆMid-level Intermediate Representationï¼‰ãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚
- MIRã¯Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ ¹å¹¹ã‚’ãªã™ä¸­é–“è¡¨ç¾ã§ã‚ã‚‹ã€‚ä¸»ã«ã¯åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ã‚°ãƒ©ãƒ•ã«åŸºã¥ã„ãŸä¸­é–“è¡¨ç¾ã«ãªã£ã¦ãŠã‚Šã€å‹ä»˜ã‘ã‚‚ãªã•ã‚ŒãŸçŠ¶æ…‹ã§ã‚ã‚‹ã€‚
- ãŸã¨ãˆã°ä¸‹è¨˜ãŒå«ã¾ã‚Œã‚‹ã€‚
  - ãƒœãƒ­ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆBorrow Checkï¼‰ã€‚
  - å˜ç›¸åŒ–ï¼ˆMonomorphizationï¼‰ã€‚

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å…¨ä½“çš„ãªæ§‹æˆ: MIR

MIRã¯ã€æ¬¡ã®cargoã‚³ãƒãƒ³ãƒ‰ã§å‡ºåŠ›ã§ãã‚‹ã€‚

```
cargo rustc -- -Z unpretty=mir 
```

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å…¨ä½“çš„ãªæ§‹æˆ: MIR


---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å…¨ä½“çš„ãªæ§‹æˆ: MIR

HIRã§ä½¿ç”¨ã—ãŸã®ã¨åŒã˜ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦MIRã‚’å‡ºåŠ›ã•ã›ã¦ã¿ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ãªå‡ºåŠ›ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

```
fn main() -> () {
    let mut _0: ();
    let _1: std::vec::Vec<i32>;
// ...
    bb1: {
        _6 = ShallowInitBox(move _5, [i32; 10]);
        _26 = copy ((_6.0: std::ptr::Unique<[i32; 10]>).0: std::ptr::NonNull<[i32; 10]>) as *const [i32; 10] (Transmute);
        _27 = copy _26 as *const () (PtrToPtr);
        _28 = copy _27 as usize (Transmute);
        _29 = AlignOf([i32; 10]);
        _30 = Sub(copy _29, const 1_usize);
        _31 = BitAnd(copy _28, copy _30);
        _32 = Eq(copy _31, const 0_usize);
        assert(copy _32, "misaligned pointer dereference: address must be a multiple of {} but is {}", copy _29, copy _28) -> [success: bb15, unwind unreachable];
    }
```

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å…¨ä½“çš„ãªæ§‹æˆ: MIR

ãƒã‚¤ãƒ³ãƒˆã¯ä¸‹è¨˜ã®é€šã‚Šã€‚

- `bbX`, `scope X`ã®ã‚ˆã†ãªè¨˜è¿°
- `move`ã‚„`copy`ã€`drop`ãªã©ã€ãƒœãƒ­ãƒ¼ãƒã‚§ãƒƒã‚«ãƒ¼ã«é–¢é€£ã™ã‚‹è¨˜è¿°ã‚’ç¢ºèªã§ãã‚‹ã€‚
- `return`ã‚„`goto`ã€`unreachable`ãªã©ã€åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ã«é–¢ä¿‚ã—ãã†ãªã‚‚ã®ã‚’ç¢ºèªã§ãã‚‹ã€‚

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### bbX, scope X

- `scope`: è»¸è§£æå¾Œã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã‚¹ã‚³ãƒ¼ãƒ—æ§‹é€ ã‚’è¡¨ç¾ã™ã‚‹ã€‚

```
            scope 3 {
                debug iter => _9;
                let _13: i32;
                scope 4 {
                    debug num => _13;
                }
            }

```

- `bb`: Basic Blocksã®ç•¥ã§ã€åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ã‚°ãƒ©ãƒ•ã®ä¸€å˜ä½ã‚’ç¤ºã™ã€‚ï¼ˆ`_3`ãªã©ã¯ã€MIRã®ä¸€ç•ªä¸Šã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹å¤‰æ•°æƒ…å ±ã‚’æŒ‡ã—ã¦ã„ã‚‹ï¼‰

```
    bb0: {
        _3 = SizeOf([i32; 10]);
        _4 = AlignOf([i32; 10]);
        _5 = alloc::alloc::exchange_malloc(move _3, move _4) -> [return: bb1, unwind continue];
    }
```

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### move, copy, drop

- ãã®å€¤ãŒmoveã™ã‚‹ã®ã‹ã€copyã™ã‚‹ã®ã‹ã€ãã“ã§dropã™ã‚‹ã®ã‹ã‚’ç¤ºã—ã¦ã„ã‚‹ã€‚

```
    bb3: {
        _9 = move _8;
        goto -> bb4;
    }
```

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å®Ÿéš›ã®ä¸­é–“è¡¨ç¾ã‚’å°‘ã—èª­ã‚“ã§ã¿ã‚‹

ï¼ˆæ™‚é–“ãŒã‚ã‚Œã°ã€‚ãªã‘ã‚Œã°é£›ã°ã™äºˆå®šã§ã™ã€‚ï¼‰

---

## Rustã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®æ§‹æˆã¨ç‰¹å¾´
### å…¨ä½“çš„ãªæ§‹æˆ: LLVM IRï¼ˆCodegenï¼‰

- MIRã‹ã‚‰LLVM IRãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚ãƒã‚¤ãƒŠãƒªãŒç”Ÿæˆã•ã‚Œã‚‹ç›´å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã§ã‚ã‚‹ã¨è¨€ãˆã‚‹ã€‚
- ãƒã‚¤ãƒŠãƒªã®ç”Ÿæˆã¾ã§ã«ã¯ã•ã‚‰ã«ã„ãã¤ã‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’çµŒã‚‹ãŒã€è©³ã—ãã¯ä¸‹è¨˜ã®è¨˜äº‹ã‚’å‚è€ƒã«ã§ãã‚‹ã€‚
  - Resolving Rust Symbols: https://blog.shrirambalaji.com/posts/resolving-rust-symbols/
  - ã¡ãªã¿ã«ã€ã“ã®è¨˜äº‹ã®è‘—è€…ã¯æ˜¨å¹´Rust.Tokyoã«ç™»å£‡ã—ã¦ãã‚ŒãŸã€‚

---
