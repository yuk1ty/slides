---
marp: true
theme: rose-pine-custom
paginate: true
---

<!-- _paginate: skip -->

# カジュアルコントリビュータと学ぶRustコンパイラ

2025/07/29
Rustの現場に学ぶ 〜Webアプリの裏側からOS、人工衛星まで〜

---

## 目次

- 前提の整理
- カジュアルコントリビュータ？
- Rustコンパイラの構成と特徴
- Rustコンパイラ開発の個人的体験

---

## 前提の整理

- コンパイラに関するある程度の知識は既知とさせてください🙇🏻‍♀️ 説明しているとさすがに15分〜20分では扱いきれないためです。
  - 字句解析（レキサ）、構文解析（パーサー）、抽象構文木あたりのイメージがつけば大丈夫…だと思う。
  - 昔記事を書いたらしい（6年前って書いてあってびっくりしてる）。
    - Rust LT#2 で話をしました & その話の詳細な解説: https://blog-dry.com/entry/2018/08/03/184806
    
---

## 前提の整理

- 尺の都合で実装レベルの話までは踏み込めません。
- 懇親会でお話ししましょう…！私も初心者ですが。
    
---

## カジュアルコントリビュータ？
### 定義

- 私が勝手にそう呼んでいるだけで、一般的な定義はない。
- 時折現れてIssueを解決していく人。
- ガチ勢ではない（ので、「カジュアル」）が、多少はコンパイラに詳しいだろうということで今日話をする。

---

## カジュアルコントリビュータ？
### 動機

- 転職してRustエンジニアではなくなったので、Rustを触る機会が激減した。
- 前からやってみたかったRust本体へのコントリビューションをしてみることに。
  - 後述するようにAIの力のおかげで、かなりコントリビュートしやすくなった。

---

## Rustコンパイラの構成と特徴

- **全体的な構成**: よくあるコンパイラの構成。ASTを構築後、中間表現に変換し、コード生成を経てバイナリが作られる。
- **特徴的な設計**: クエリベースのコンパイルが走る。丁寧なエラーメッセージ、トレイトリゾルバあたりはRust特有かも。

---

## Rustコンパイラの構成と特徴
### 全体的な構成

Rustコンパイラ内では、大まかには次のように「中間表現（IR）」が変換されていく。

- AST
- HIR
- MIR
- LLVM IR (Codegen)

上のフェーズから下のフェーズに中間表現が直されていくことを「**lowering**」と呼ぶ。

---

## Rustコンパイラの構成と特徴
### 全体的な構成: AST

- ソースコードを解析（字句、構文）し、抽象構文木（Abstract Syntax Tree; AST）に直すフェーズ。
- ちなみにRustは、再帰下降構文解析で、パーサーを手で実装している。

---

## Rustコンパイラの構成と特徴
### 全体的な構成: HIR

- HIR (High-level Intermediate Representation) と呼ばれる中間表現がまずは生成される。その後THIR (Typed High-level Intermediate Representation)が生成され、次のフェーズ（MIR）に渡される。
- 主には脱糖（desugar）を担う。たとえば、Rustの文法上現れる下記の文法機能は、コンパイラ内部では違う形で扱われる。
  - for式やwhile式は、すべてmatch + loopに変換される。
  - asyncやawaitは、コンパイラ内部表現としてコルーチンに変換される。

---

## Rustコンパイラの構成と特徴
### 全体的な構成: HIR

- そのほか、型に関するさまざまな解析がかけられる。
  - 型推論、トレイトと実装の紐付け、型チェックはHIRへの変換のタイミングで行われる。
  - パターンマッチ時に現れる網羅性チェックは、THIRへの変換のタイミングで行われる。

---

## Rustコンパイラの構成と特徴
### 全体的な構成: HIR

（コードからHIRを出力してみた例を出す）

---

## Rustコンパイラの構成と特徴
### 全体的な構成: HIR

HIRは、次のcargoコマンドで確認できる。

```
cargo rustc -- -Z unpretty=hir-tree
cargo rustc -- -Z unpretty=hir
cargo rustc -- -Z unpretty=thir-tree
```
